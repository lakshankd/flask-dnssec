{% extends "base_with_navbar.html" %}

{% block title %}Backup DNS Zone - DNSSEC Guardian{% endblock %}

{% block content %}
    <div class="backup-container">
        <a href="{{ url_for('dashboard') }}" class="back-arrow">
            &#8592; Dashboard
        </a>
        <h2 class="backup-header">Backup Zone File</h2>

        <form class="back-form" id="backup-availability-form">
            <label class="backup-label" for="zone-path">Path to Zone File</label>
            <input class="backup-input" type="text" id="zone-path" name="zone-path"
                   placeholder="/etc/bind/zones/db.example.com" required >

            <label class="backup-label" for="file-name">File Name</label>
            <input class="backup-input" type="text" id="file-name" name="file-name" placeholder="example.com" required>

            <button class="backup-availability-btn" type="button" id="check-availability-btn">Check Availability
            </button>
            <p id="backup-availability-info" class="backup-availability-info"></p>
        </form>

        <form class="back-form" id="backup-form">
            <p id="backup-info" class="backup-info-text">Your file will be backed up to:
                /etc/bind/backup/[date]_[filename].backup</p>

            <button class="backup-availability-btn" type="button" id="confirm-backup-btn" disabled>Confirm Backup
            </button>
        </form>

        <button class="backup-next-step-btn">
            Next: Generate Keys &rarr;
        </button>
    </div>

    <!-- Include jQuery for simplicity -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $('#check-availability-btn').on('click', function() {
            const zonePath = $('#zone-path').val();
            const fileName = $('#file-name').val();

            $.ajax({
                url: "{{ url_for('check_zone_file_availability') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ zone_path: zonePath, file_name: fileName }),
                success: function(response) {
                    if (response.available) {
                        $('#confirm-backup-btn').prop('disabled', false);  // Enable confirm button
                        $('#backup-availability-info').text('File is available. Ready for backup.');
                    } else {
                        alert('File not available. Please check the path and try again.');
                    }
                }
            });
        });

        // Confirm Backup
        $('#confirm-backup-btn').on('click', function() {
            const zonePath = $('#zone-path').val();
            const fileName = $('#file-name').val();

            $.ajax({
                url: "{{ url_for('confirm_backup_zone_file') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ zone_path: zonePath, file_name: fileName }),
                success: function(response) {
                    alert('Backup successful: ' + response.backup_path);
                }
            });
        });
    </script>
{% endblock %}